# 9. ECS 클러스터 생성 및 서비스 배포(Fargate 기반)

Amazon ECS (Elastic Container Service)는 컨테이너를 클러스터 기반으로 **자동 배포 및 관리**하는 서비스입니다.

우리는 Fargate를 사용할 거예요 → 서버 관리 필요 없음!

## 🧭 전체 흐름

1. ECS 클러스터 생성
2. Task 정의 만들기 (ECR 이미지 지정)
3. 서비스 생성 (퍼블릭 서브넷에 배포)
4. 결과 확인 (브라우저 접속)

## 🛠️ 실습 절차

### 🎯 1단계: ECS 클러스터 생성

### 📍 AWS 콘솔 → ECS

1. 왼쪽 메뉴에서 **클러스터** 클릭
2. [클러스터 생성] 클릭

### 설정

- **클러스터 이름**: `golang-cluster` (또는 자유롭게)
- **인프라 유형**: **AWS Fargate** ✅ 선택(네트워크 전용)
- 나머지 기본값 유지
- [클러스터 생성] 클릭

### ✅ 태스크 정의 만들기 (Fargate)

📍 경로: **ECS 콘솔 → 태스크 정의 → [새로 만들기]**

### ② Task 정의 생성

1. ECS → **Task 정의** → **새로 생성**
2. 이름: `golang-task`
3. 유형: Fargate
4. 플랫폼: 최신 (예: 1.4.0)
5. 역할: `ecsTaskExecutionRole` 선택

**ECS → 작업 정의 → 새로 생성**

1. 이름: `craft` 또는 원하는 이름
2. 런타입: Fargate
3. 플랫폼 버전: Latest
4. 역할: `ecsTaskExecutionRole`
5. 컨테이너 추가:
    - 이름: `craft-container`
    - 이미지:
        
        ```
        <ECR-URI>/craft:latest
        ```
        
    - 포트: `8080`

→ 저장 → **작업 정의 등록 완료**

![image.png](9%20ECS%20%ED%81%B4%EB%9F%AC%EC%8A%A4%ED%84%B0%20%EC%83%9D%EC%84%B1%20%EB%B0%8F%20%EC%84%9C%EB%B9%84%EC%8A%A4%20%EB%B0%B0%ED%8F%AC(Fargate%20%EA%B8%B0%EB%B0%98)/image.png)

## ECS **Task 정의(Task Definition)** 수정하기

### 💡 수정 가능한 예시:

- 컨테이너 이미지 URI 변경 (예: 최신 ECR 이미지로)
- 포트 매핑 수정
- 환경 변수 추가
- 로그 설정 추가 등

### 🔁 수정 절차:

1. **ECS > Task 정의 > golangtask:1** 클릭
2. 상단의 **새 개정 만들기(Create new revision)** 클릭
3. 필요한 설정 수정 (예: 이미지 URI → 최신 ECR URL)
4. 저장하고 **새로운 개정 등록**

## ✅ [2] ECS **서비스 재배포** 하기

### ⚙️ 목적:

- 수정된 Task 정의를 반영하여 서비스 재시작

### 🔄 재배포 절차:

1. **ECS > 클러스터 > 서비스(golangservice)** 클릭
2. [서비스 업데이트] 클릭
3. 아래 변경 사항 확인:
    - 새 Task 정의 선택 (예: `golangtask:2`)
    - 원하는 작업 수 설정 (예: 1)
4. [다음] → [다음] → [서비스 업데이트 완료]

### 컨테이너 추가

- 이름: `golang-container`
- 이미지:
    
    ```
    <AWS_ACCOUNT_ID>.dkr.ecr.ap-northeast-2.amazonaws.com/golang-app:latest
    ```
    
- 포트 매핑: `8080` → `8080` (호스트/컨테이너 동일)

→ 저장 → Task 정의 생성 완료

### ✅ 이 컨테이너의 역할 요약

| 항목 | 설명 |
| --- | --- |
| **실행 중인 앱** | Go 언어로 만든 HTTP 웹 서버 |
| **기능** | `Hello from ECS on Fargate!` 메시지를 출력하는 웹 페이지 |
| **포트** | 컨테이너 내부에서 `8080` 포트로 요청을 받고, ECS 서비스에서 이를 호스트 포트 `80`으로 매핑할 수 있음 |
| **동작 방식** | ECS Task가 이 컨테이너를 실행하고, ALB 또는 퍼블릭 IP를 통해 외부에서 접근 가능 |
| **이미지 소스** | `docker build`로 만든 `golang-app` 이미지 (ECR에 푸시됨) |
| **기반** | Amazon ECS on Fargate (EC2 인스턴스 없이 컨테이너 실행) |

### Golang으로 작성된 간단한 웹 애플리케이션을 Fargate 기반으로 1개 태스크(컨테이너)에서 실행하여, 외부에서 HTTP 요청을 수신하고 응답하는 서버 역할

---

### ③ ECS 서비스 생성

- ECS → 클러스터 → `golang-cluster` 선택
- **서비스** 탭 → 생성
- Launch Type: Fargate
- Task 정의: 방금 만든 `golang-task`
- 서비스 이름: `golang-service`
- 원하는 Task 수: `1`
- VPC/서브넷 선택
- **퍼블릭 IP 자동 할당: 활성화(ENABLED)**

![image.png](9%20ECS%20%ED%81%B4%EB%9F%AC%EC%8A%A4%ED%84%B0%20%EC%83%9D%EC%84%B1%20%EB%B0%8F%20%EC%84%9C%EB%B9%84%EC%8A%A4%20%EB%B0%B0%ED%8F%AC(Fargate%20%EA%B8%B0%EB%B0%98)/image%201.png)

![image.png](9%20ECS%20%ED%81%B4%EB%9F%AC%EC%8A%A4%ED%84%B0%20%EC%83%9D%EC%84%B1%20%EB%B0%8F%20%EC%84%9C%EB%B9%84%EC%8A%A4%20%EB%B0%B0%ED%8F%AC(Fargate%20%EA%B8%B0%EB%B0%98)/image%202.png)

### ④ 보안 그룹 설정

- 인바운드 규칙에 **8080 포트 열려 있어야 함**
- 없으면 `golang-sg` 같은 SG를 새로 만들고 적용

### 🔍 체크포인트 (꼭 확인!)

- 보안 그룹에 **인바운드 규칙으로 포트 80 (HTTP) 허용** 되어 있는지 확인하세요
    - 만약 안 되어 있다면, **보안 그룹 편집 → 인바운드 규칙 추가**로
        - 유형: HTTP
        - 포트 범위: 80
        - 소스: 0.0.0.0/0 (전체 접근 허용) 또는 IP 제한

### ⑤ 배포 완료 후 확인

- 클러스터 → Tasks 탭 → 실행 중인지 확인
- **퍼블릭 IP 확인 후 접속**
    
    ```
    http://<퍼블릭-IP>:8080
    ```
    

## ✅ 정상 출력

```
Hello from ECS on Fargate!
```

**배포가 성공하면 실제 웹서비스가 ALB를 통해 인터넷에 노출**되는 상태

![image.png](9%20ECS%20%ED%81%B4%EB%9F%AC%EC%8A%A4%ED%84%B0%20%EC%83%9D%EC%84%B1%20%EB%B0%8F%20%EC%84%9C%EB%B9%84%EC%8A%A4%20%EB%B0%B0%ED%8F%AC(Fargate%20%EA%B8%B0%EB%B0%98)/image%203.png)

### ✅ 웹 애플리케이션 흐름 요약

1. 사용자가 브라우저로 `ALB 주소` 또는 `퍼블릭 IP:80` 접근
2. 해당 요청이 ECS 서비스 → Task → 컨테이너의 **8080 포트**로 전달
3. Go 서버가 `Hello from ECS on Fargate!` 응답 반환

Golang으로 작성된 간단한 웹 애플리케이션을 Fargate 기반으로 1개 태스크(컨테이너)에서 실행하여, 외부에서 HTTP 요청을 수신하고 응답하는 서버 역할

## 🧠 팁

- 작업 정의를 먼저 생성하지 않으면 ECS 서비스는 만들 수 없어요
- 태스크 정의는 **배포의 설계도 역할**을 해요 (컨테이너 이미지, 포트, 로그, 메모리 등)

![image.png](9%20ECS%20%ED%81%B4%EB%9F%AC%EC%8A%A4%ED%84%B0%20%EC%83%9D%EC%84%B1%20%EB%B0%8F%20%EC%84%9C%EB%B9%84%EC%8A%A4%20%EB%B0%B0%ED%8F%AC(Fargate%20%EA%B8%B0%EB%B0%98)/image%204.png)

| 목적 | 퍼블릭 IP 위치 | 설명 |
| --- | --- | --- |
| ECS 서비스 접근 | **ECS 작업(Task)의 ENI** | Fargate가 자동으로 할당 |
| EC2에서 실행 중인 Go 앱 테스트 | **EC2 퍼블릭 IP** | 직접 curl 등으로 테스트할 때 사용 |

### Network Mode가 `awsvpc`일 경우

ECS Task는 **고유한 ENI를 가지므로, 해당 ENI에 연결된 보안 그룹이 따로 존재**합니다.

ECS 콘솔 → 작업(Task) → **ENI ID 클릭** → 연결된 **보안 그룹 확인 및 수정**.

### 🔁 마무리 확인 체크리스트

ECS 태스크가 실행 중인가?

퍼블릭 IP로 curl 요청했을 때 연결 가능한가?

보안 그룹에서 포트 80 허용했는가?

컨테이너 내부 포트와 ECS 포트 매핑이 일치하는가?